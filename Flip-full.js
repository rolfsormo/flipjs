/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*! Flip.js | (c) 2013 Rolf Sormo | https://github.com/rolfsormo/flipjs */

var requirejs,require,define;(function(e){function c(e,t){return f.call(e,t)}function h(e,t){var n,r,i,s,o,a,f,l,c,h,p=t&&t.split("/"),d=u.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(l=0;l<e.length;l+=1){h=e[l];if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))break;l>0&&(e.splice(l-1,2),l-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=l;break}}}if(s)break;!a&&v&&v[r]&&(a=v[r],f=l)}!s&&a&&(s=a,o=f),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function p(t,r){return function(){return n.apply(e,l.call(arguments,0).concat([t,r]))}}function d(e){return function(t){return h(t,e)}}function v(e){return function(t){s[e]=t}}function m(n){if(c(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!c(s,n)&&!c(a,n))throw new Error("No "+n);return s[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function y(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice;r=function(e,t){var n,r=g(e),i=r[0];return e=r[1],i&&(i=h(i,t),n=m(i)),i?n&&n.normalize?e=n.normalize(e,d(t)):e=h(e,t):(e=h(e,t),r=g(e),i=r[0],e=r[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return p(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:y(e)}}},t=function(t,n,u,f){var l,h,d,g,y,b=[],w;f=f||t;if(typeof u=="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){g=r(n[y],f),h=g.f;if(h==="require")b[y]=i.require(t);else if(h==="exports")b[y]=i.exports(t),w=!0;else if(h==="module")l=b[y]=i.module(t);else if(c(s,h)||c(o,h)||c(a,h))b[y]=m(h);else{if(!g.p)throw new Error(t+" missing "+h);g.p.load(g.n,p(f,!0),v(h),{}),b[y]=s[h]}}d=u.apply(s[t],b);if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(d!==e||!w)s[t]=d}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){return typeof s=="string"?i[s]?i[s](o):m(r(s,o).f):(s.splice||(u=s,o.splice?(s=o,o=a,a=null):s=e),o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n)},n.config=function(e){return u=e,u.deps&&n(u.deps,u.callback),n},requirejs._defined=s,define=function(e,t,n){t.splice||(n=t,t=[]),!c(s,e)&&!c(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("almond",function(){}),function(e,t){var n="Flip";typeof define=="function"&&define.amd?define(n,t):typeof exports=="object"?module.exports=t():e[n]=t()}(this,function(){function e(){this.adapters=[]}return e.toString=function(){return"Flip"},e.prototype.addAdapter=function(e){console.log("Adding adapter:",e.adapterName),this.adapters.push(e)},e.prototype.getAdapter=function(e){for(var t=0;t<this.adapters.length;t++){var n,r,i=this.adapters[t].adapterName;if(e.common){n={};for(r in Object.keys(e.common))n[r]=e.common[r];if(e[i])for(r in Object.keys(e[i]))n[r]=e[i][r]}else n=e;if(this.adapters[t].detect(n))return this.adapters[t]}},e.prototype.connect=function(e,t,n){typeof t=="function"&&(n=t,t={});var r=this.getAdapter(t);if(!r)throw new Error("No suitable adapter found");(new r(t)).connect(e,n)},e.prototype.generateId=function(){function e(e){return e.toString(16).substring(1)}function t(){return Math.floor((1+Math.random())*65536)}return e((new Date).getTime())+e(t())+e(t())+e(t())},new e}),define("Flip",function(){}),function(e,t){var n="KeyValueAdapter";typeof define=="function"&&define.amd?define(n,["Flip","MongoMatcher"],t):typeof exports=="object"?module.exports=t(require("./Flip"),require("./MongoMatcher")):e[n]=t(e.Flip,e.MongoMatcher)}(this,function(e,t){return function(n){function r(e){this.options=e}function i(e,t){for(var n in e)if(e[n].key===t)return!0}return r.adapterName=n.adapterName,r.detect=function(e){return n.detect(e)},r.toString=function(){return"KeyValueAdapter::"+n.adapterName},r.prototype.connect=function(e,t){var r=this;this.dbName=e,n.init(function(){n.get("system",function(e){r.system=e||{},r.system.collections=r.system.collections||{},t(undefined,r)})})},r.prototype.collection=function(r,s){function f(){}var o=this,u=this.system.collections[r]||{};u.key=u.key||this.dbName.substring(0,2)+r.substring(0,2);var a=0;while(i(this.system.collections,u.key))u.key=u.key+a,a++;return f.prototype.find=function(e,r){var i=new t(e);n.keys(function(t,s){function a(t,n){if(t)return r(t);if(n){var s=JSON.parse(n);console.log(" ============= MATCHING",e,"to",s),i.match(s)&&o.push(s),console.log("----")}f--,f||(console.log("res",o),r(undefined,o))}if(t)return r(t);var o=[],f=1;for(var l=0;l<s.length;l++){var c=s[l],h=c.split("_");console.log(u.key,h),h.length==2&&u.key===h[0]&&(f++,n.get(c,a))}a()})},f.prototype.insert=function(t,r){t._id||(t._id=e.generateId());var i=u.key+"_"+t._id;n.set(i,JSON.stringify(t),function(e,n){r(e,t)})},f.prototype.update=function(e,t){n.set(o.dbName,r,e._id,JSON.stringify(e),function(n,r){t(n,e)})},f.prototype.remove=function(e,t){this.find(e,function(e,r){function i(e){if(e)return t(e);s--,s||t()}if(e)return t(e);if(!r.length)return t();var s=1;for(var o=0;o<r.length;o++){var a=u.key+"_"+r[o]._id;s++,n.remove(a,i)}handle()})},f.prototype.drop=function(e){n.keys(function(t,r){function i(t){if(t)return e(t);s--,s||e()}if(t)return e(t);var s=1;for(var o=0;o<r.length;o++){var a=r[o].split("_");console.log("r",a),a[0]===u.key&&(s++,n.remove(a[1],i))}i()})},this[r]=new f,this[r]},r.prototype.dropDatabase=function(e){console.log("===================== DROPPING DATABASE",this.dbName),n.keys(function(t,r){function i(t){if(t)return e(t);s--,s||e()}var s=1;for(var o=0;o<r.length;o++)n.remove(r[o],i);i()})},r.prototype.toString=function(){return"KeyValueAdapter::"+n.adapterName+"//"+this.dbName},r}}),define("KeyValueAdapter",function(){}),function(e,t){typeof define=="function"&&define.amd?require(["Flip","KeyValueAdapter"],t):typeof exports=="object"?t(require("../Flip"),require("../KeyValueAdapter")):t(e.Flip,e.KeyValueAdapter)}(this,function(e,t){var n=!1;e.addAdapter(t({adapterName:"LocalStorage",detect:function(e){try{return"localStorage"in window&&window.localStorage!==null}catch(t){return!1}},init:function(e){e()},keys:function(e){n&&console.log("-> KEYS");var t=[];for(var r=0;r<localStorage.length;r++)t.push(localStorage.key(r));e(undefined,t)},get:function(e,t){n&&console.log("-> GET",e),t(undefined,window.localStorage.getItem(db+"_"+collection+"_"+e))},set:function(e,t,r){n&&console.log("-> SET",e,t),window.localStorage.setItem(e,t),r(undefined,t)},remove:function(e,t){n&&console.log("-> REMOVE",e),window.localStorage.removeItem(e),t()}}))}),define("adapters/LocalStorage",function(){}),function(e,t){typeof define=="function"&&define.amd?require(["Flip","KeyValueAdapter"],t):typeof exports=="object"?t(require("../Flip"),require("../KeyValueAdapter")):t(e.Flip,e.KeyValueAdapter)}(this,function(e,t){var n=!0,r={};e.addAdapter(t({adapterName:"MemStorage",detect:function(e){return!e.requirePersistency},init:function(e){e()},keys:function(e){n&&console.log("[ KEYS"),console.log("keys",Object.keys(r)),e(undefined,Object.keys(r))},get:function(e,t){n&&console.log("[ GET",e),t(undefined,r[e])},set:function(e,t,i){n&&console.log("[ SET",e,t),r[e]=t,i()},remove:function(e,t){n&&console.log("[ REMOVE",e),delete r[e],t()}}))}),define("adapters/MemStorage",function(){}),function(e,t){console.log("loading...");if(typeof define=="function"&&define.amd)throw new Error("FileStorage works only in Node.js");if(typeof exports!="object")throw new Error("FileStorage works only in Node.js");var n;try{n=require("libyaml")}catch(r){}var i;try{i=require("bson")}catch(r){}t(require("../Flip"),require("../KeyValueAdapter"),n,i,require("fs"))}(this,function(e,t,n,r,i){var s=!1;e.addAdapter(t({adapterName:"FileStorage",detect:function(e){return this.options=e,this.options.directory=this.options.directory||"db",s&&console.log("Allow File Storage: ",e.allowFileStorage),e.allowFileStorage},init:function(e){s&&console.log("Creating: ",this.options.directory),i.mkdir(this.options.directory,function(t){e()})},keys:function(e){s&&console.log("[ KEYS"),i.readdir(this.options.directory,function(t,n){if(t)return e(t);s&&console.log("files",n),e(undefined,n)})},get:function(e,t){s&&console.log("[ GET",e),e=e.replace("/","_"),i.readFile(this.options.directory+"/"+e,function(e,n){if(e)return t(e);t(undefined,n)})},set:function(e,t,n){s&&console.log("[ SET",e,t),e=e.replace("/","_"),i.writeFile(this.options.directory+"/"+e,t,function(e){if(e)return n(e);n()})},remove:function(e,t){s&&console.log("[ REMOVE",e),e=e.replace("/","_"),i.unlink(this.options.directory+"/"+e,function(e){if(e)return t(e);t()})}}))}),define("adapters/FileStorage",function(){}),require(["Flip"]);